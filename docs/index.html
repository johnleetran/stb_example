<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width" />
        <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
        <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
      </head>
    <body>
        <button id="startWorkerButton" onclick="startWorker()">Start Worker</button>
        <button id="runDummyThread" onclick="runDummyThread()">runDummyThread</button>
        <button id="terminateWorkerButton" onclick="terminateWorker()">Terminate Worker</button>
        <h1>Upload a PSD</h1>
        <input type="file" id="imageFile" capture>
        <img src="" id="rendition">
        <!-- <div class="canvas-div">
            <canvas id="canvas" ></canvas>
        </div> -->
        <script crossorigin="true">
            let worker;

            document.addEventListener('DOMContentLoaded', () => {
                document.querySelector('#imageFile').addEventListener('change', handleFileInput);
            });

            async function startWorker() {
                worker = new Worker("./index-worker.js");
                worker.onmessage = (e) => {
                    if(e.data.jobType == "handleFileInput"){
                        // TODO: code to render image on canvas
                        console.log(e.data);
                        drawImageOnCanvas(e.data.renditionUrl)
                    } else {
                        console.log("warning: did not do anything upon worker message")
                    }
                };

                worker.onerror = (err) => {
                    console.log("worker errored: ", err)
                }

                worker.postMessage({
                    jobType: "initWorker",
                })
            }

            function terminateWorker() {
                worker.terminate()
            }

            function randomNumber() {
                return Math.floor(Math.random() * 10000);
            }

            async function handleFileInput(e){
                console.log('change event fired for input field');
                let file = e.target.files[0];
                var reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = function (e) {
                    console.log(e)
                    let bits = e.target.result;

                    let inputFileName = `/persistent/input-${randomNumber()}.psd`;
                    let outputFileName = `/persistent/output-${randomNumber()}.png`;
                    worker.postMessage({
                        inputFileName: inputFileName,
                        outputFileName: outputFileName,
                        jobType: "handleFileInput",
                        bits: bits,
                    });
                }
            }

            async function runDummyThread(e){
                worker.postMessage({
                    jobType: "runDummyThread",
                })
            }

            function drawImageOnCanvas(url, imageData, width, height){
                let img = document.getElementById("rendition");
                img.src = url;
            }

        </script>
    </body>
</html>